"use strict";

const Log = require("../dist/logger");
const optionalRequire = require("optional-require")(require);
const clsProvider = optionalRequire("@walmart/electrode-cls-provider");
const tryCatch = require("@walmart/try-catch");
const fyi = require("@walmart/electrode-fyi");

const getRequest = (opts, from) => {
  let req = opts && opts.request;

  // user didn't pass in opts or opts.request
  if (req === undefined) {
    // do we have CLS provider?
    if (clsProvider && clsProvider.getRequest) {
      req = tryCatch(clsProvider.getRequest);
      if (!req) {
        fyi.error(`ui-logger.${from} unable to get request from CLS`);
      }
    } else {
      fyi.error(`ui-logger.${from} missing opts.request and no CLS provider`);
    }
  }

  return req;
};

Log._addLogMessage = (data, opts) => {
  const req = getRequest(opts, "_addLogMessage");
  if (req !== undefined) {
    req.log(data.tags, data.data);
  }
};

Log._flush = () => {
  fyi.warn("ui-logger._flush: Log flushing is not valid on server");
};

module.exports = Log;
