# Service Initializer

Hapi plugin to initialize and provide service clients in `request`

## Overview

This is a Hapi plugin that takes an Electrode app's `services` config, for each provider client, it will make an instance of the client available in `request.app.services`.  The client has to be an ***Electrode Swapi*** client and implements a `static create` function,

The goal is to make it convenient for you to setup and initialize service provider clients so you can invoke the service APIs.

## Usage

Install

```
npm install @walmart/electrode-service-initializer --save
```

Sample code:

```js
const serviceInitializer = require("@walmart/electrode-service-initializer");

server.register([ { register: serviceInitializer } ], function (error) {} );
```

Where `server` is a `Hapi` server.

## Services config

### TL;DR

You have a service provider client as module `@walmart/foobar-client`.  It has a `static create` method and a static method `providerName` that returns `foobar`:

   * With this config
```js
{
  "services": {
    "consumerId": "91e1b78e-261b-4676-8317-4cf5bfa24a42",
    "privateKey": { ... }
    "providers": {
      "@walmart/foobar-client": {
        "autoInit": true
      }
    }
  }
}
```

An instance of `foobar-client` will be accessible at `server.app.services.foobar` or `req.app.services.foobar`, or `req.app.services["@walmart/foobar-client"]`

### Long details

An Electrode app should provide app config.  In the app config, there should be a `services` section.  This should contain the app's SOARI `consumer ID`, `private key`, and a `providers` object.

The providers should contain one object for each provider.

   * The key should be the module name of the provider client (`Client`)
   * The initializer will try to use `require` to load the module with that name
   * If it's loaded, the initializer will call `static create` to create an instance
   * If an instance is created, the initializer will assign it to `server.app.services[<key>]` and `server.app.services[<Client.providerName()>]`

For example:

```js
{
  "services": {
    "consumerId": "91e1b78e-261b-4676-8317-4cf5bfa24a42",
    "privateKey": {
      "file": "config/keys/soa-private.pem",
      "version": 1,
      "algorithm": "RSA",
      "encoding": "PKCS#8"
    },
    useRegistry: true|false,
    "providers": {
      "sample-client-module": {
        "autoInit": true
      },
      "foo": {
        "module": "foo-client",
        "autoInit": false,
        "autoDiscovery": false
      },
      "withHost": {
        "module": "bar-client",
        "host": "bar.qa.walmart.com"
      },
      "customEnv": {
        "env": "stg"
      }
    }
  }
}
```

  * If you install this plugin, then an instance of the `sample-client` will be available as `request.app.services.sample`.  Assuming `sample-client` is an ***Electrode Swapi*** client with a `static create` factory function and `providerName` === `sample`.

  * An instance of `foo-client` will not be initialized because the flag `autoInit` is set to false.

  * If a provider specifies `host`, like the `withHost` provider, then it's used to override the host specified by the client module.

  * provider env - you can set a different env for a single provider

  * Logging to console can be controlled with some options. This is not recommended in production and is at your own risk (don't turn off logging then ask for help when things don't work). Set these options as keys in the `services` object.
    * autoInitBeQuiet             - disables logs to stderr.
    * autoInitNoCautionWarnings   - disables logs to stderr.
