"use strict";
const electrodeServer = require("electrode-server");

let random = false;
let responseDelay = parseInt(process.argv[2]) || 0;

if (responseDelay) {
  console.log("service response delay", responseDelay);
  random = process.argv[3] === "random";
  if (random) {
    console.log("response delay will be randomized");
    responseDelay = Math.round(responseDelay / 2 + 0.5);
  }
}

function create(opts) {
  return electrodeServer(opts).then(server => {
    server.route({
      method: "post",
      path: "/test1",
      handler: (request, reply) => {
        let delay = responseDelay;
        if (responseDelay > 0) {
          if (random) {
            delay = Math.round(0.5 + Math.random() * responseDelay + Math.random() * responseDelay);
          }
        }

        setTimeout(() => {
          reply({
            delay,
            name: `test1 - ${Date.now()}`
          });
        }, delay);
      }
    });
    return server;
  });
}

module.exports = { create };

// to configure the port server listens, set env PORT.
// ie: PORT=80 node test-server.js

if (require.main === module) {
  create();
}
