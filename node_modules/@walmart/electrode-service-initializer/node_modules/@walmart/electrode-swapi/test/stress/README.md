# stress test for swapi

This directory contains files for running stress tests on using swapi.

# Setup

The test consists of two parts that need to be executed on two separate OneOps VMs.

1.  The mock service `test-server.js`.
2.  The simple application `simple-app.js`.

Each VM needs to have Node 6 or above setup.

## nginx

OneOps VM only opens port 80.

While the tests can be run on 80 directly, it will affect NodeJS' performance.

To get true perf results, the test should be run with `nginx` as a proxy.

## test-server

First get a VM to host a mock service for `simple-app` to call.

On the VM:

1.  `mkdir test-server`
2.  `cd test-server`
3.  `npm init --yes`
4.  `npm --registry http://npme.walmart.com install electrode-server --save`
5.  copy the file `test-server.js`
6.  `node test-server.js`

> Note that if your VM doesn't have nginx setup as proxy to forward request from port 80 to 3000, then you need to run it with `PORT=80 sudo -E`.

### Command line arguments

The test server takes two arguments.

-   The first one is a number indicating the millisecond server should delay before sending response
-   If the second one is `random`, then the delay will be randomized within the value given by the first argument.

### PM2

If you want to run the test server in cluster mode with PM2, copy the following into `pm2.json`.

Assuming you create `test-server` under `/home/app`.

> Note also the `args` specifying a random `1000ms` delay for response.

```js
{
  "script": "/home/app/test-server/test-server.js",
  "instances": "max",
  "exec_mode": "cluster",
  "autorestart": true,
  "args": [ 1000, "random" ],
  "node_args": [],
  "watch": false,
  "merge_logs": false,
  "name": "test-server",
  "cwd": "/home/app/test-server"
}
```

The run it with `pm2 start pm2.json`.

> You might have to install `pm2` with `npm --registry http://npme.walmart.com install -g pm2`

## simple app

On another VM:

1.  `git clone https://gecgithub01.walmart.com/electrode/electrode-swapi.git`
2.  `cd electrode-swapi`
3.  `npm --registry http://npme.walmart.com install`
4.  Update `MOCK_SERVER_HOST` in `simple-app.js` to point to the test-server VM
5.  `node test/stress/simple-app.js`

> Note that if your VM doesn't have nginx setup as proxy to forward request from port 80 to 3000, then you need to run it with `PORT=80 sudo -E`.

### Command line arguments

`simple-app.js` takes two arguments. ie: `node test/stress/simple-app.js fetch keepAlive`

If `fetch` is specified, then it will use `node-fetch` instead of `swapi`.

If `keepAlive` is specified and `swapi` is used, then it will enabled Keep Alive sockets.  Note that this is only applicable for `swapi`.

ie: To run it with swapi in keep alive mode:

```bash
node test/stress/simple-app.js swapi keepAlive
```

# Testing

Preferably on another VM, now you can hit the simple app with a lot of requests.

You can use `ab`:

```bash
ab -n 100000 -c 20 http://10.1.2.3/x1
```

# Monitoring

While the simple app is being bombarded with requests, you can start yet another one to monitor the results.

Copy the following to a file `test.sh` and run it with `bash test.sh`.

Make sure to update the IP to yours.

```bash
while true; do
  DATA1=$(curl -s http://10.1.2.3/x1)
  echo "$DATA1" 
done
```

You should see a lot of output like the following in a single line:

```js
{
  "lib": "swapi",
  "supportKeepAlive": true,
  "memoryUsage": {
    "rss": "252.12mb",
    "heapTotal": "92.07mb",
    "heapUsed": "44.97mb",
    "external": "5.07mb"
  },
  "data": [
    {
      "time": 911,
      "extra": 9,
      "obj": {
        "delay": 902,
        "name": "test1 - 1506723406409"
      }
    },
    {
      "time": 616,
      "extra": 9,
      "obj": {
        "delay": 607,
        "name": "test1 - 1506723406114"
      }
    },
    {
      "time": 536,
      "extra": 9,
      "obj": {
        "delay": 527,
        "name": "test1 - 1506723406035"
      }
    }
  ]
}
```

You can see that the `lib` used is `swapi` and Keep Alive is enabled.

You can also see the Node process's memory usage.

The `data` is an array that contains the result of the three service calls.  Each one contains a field `time` that indicates how long the service call took.

-   `delay` is time service waited before sending response.
-   `time` is app's perspective of how long it got the response
-   `extra` is difference between `time` and `delay`.

## Other end points

`simple-app` has a few more end points you can use to check status:

-   `/agent` - Get status of the keep alive agent
-   `/x1_fetch` - Explicitly use `node-fetch` to make service calls
-   `/verbose` - Turn on/off verbose mode which will log a line to console for each request

### keep alive agent status

The `/agent` endpoint returns something like the following:

```js
{
  "agent": {
    "createSocketCount": 11052,
    "createSocketErrorCount": 0,
    "closeSocketCount": 10990,
    "errorSocketCount": 0,
    "timeoutSocketCount": 0,
    "requestCount": 1090478,
    "freeSockets": {
      "172.16.114.183:80:": 44
    },
    "sockets": {
      "172.16.114.183:80:": 18
    },
    "requests": {}
  }
}
```

-   `freeSockets` are idle sockets that are kept alive and waiting to be reused.  These are destroyed after it's been idle for `freeSocketKeepAliveTimeout` milliseconds.
-   `sockets` are currently in use sockets.  These are recycled into `freeSockets` for keep alive when they are done.  They are interrupted and destroyed if they took longer than `timeout` milliseconds.  Note that this can be override by swapi `timeout.response` value if it's specified and smaller.
