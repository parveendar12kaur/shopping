"use strict";

/* eslint-disable no-invalid-this */

const groupScripts = require("electrode-react-webapp/lib/group-scripts");
const injectScripts = require("../utils/inject-scripts");
const makeRunScript = require("../utils/make-run-script");

module.exports = (name, memoize = true) => {
  const memoizeTag = memoize && Symbol.for(`electrode-index-page-unbundled-built-${name}`);

  return function(context) {
    const routeOptions = context.user.routeOptions;

    if (memoize && routeOptions.hasOwnProperty(memoizeTag)) return routeOptions[memoizeTag];

    let val = "";

    if (routeOptions.unbundledJS[name]) {
      let scripts = routeOptions.unbundledJS[name];

      if (this.props.extras) {
        scripts = scripts.concat(this.props.extras.map(x => makeRunScript(x)));
      }

      val = injectScripts(groupScripts(scripts));
    }

    if (memoize) routeOptions[memoizeTag] = val;

    return val;
  };
};
