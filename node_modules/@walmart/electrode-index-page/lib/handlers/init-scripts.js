"use strict";

const Fs = require("fs");
const groupScripts = require("electrode-react-webapp/lib/group-scripts");
const injectScripts = require("../utils/inject-scripts");
const makeRunScript = require("../utils/make-run-script");

const memoizeTag = Symbol.for(`electrode-index-page-built-initScripts`);

module.exports = function(context) {
  const routeOptions = context.user.routeOptions;

  if (routeOptions.hasOwnProperty(memoizeTag)) return routeOptions[memoizeTag];

  const getLittleLoader = () => {
    return Fs.readFileSync(require.resolve("little-loader/dist/little-loader.min.js"), "utf8");
  };

  const scripts = [this.props.littleLoader && getLittleLoader()]
    .concat(
      Boolean(routeOptions.noPciCompliance) === false && [
        // initialize the scripts that process the PCI compliance marshalled JSON data
        makeRunScript("dynamic-data"),
        makeRunScript("dynamic-data-resolver", `window._Dyn.create("#tb-djs-wml-data").get()`)
      ]
    )
    .filter(x => x);

  return (routeOptions[memoizeTag] = injectScripts(groupScripts(scripts)));
};
