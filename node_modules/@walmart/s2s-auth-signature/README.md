# S2S Auth Signature

This is a simple module that take HTTP headers and sign header values with 
SOARI consumer private key.

The signed values then should be sent in the HTTP header `WM_SEC.AUTH_SIGNATURE`.

The headers to be signed should not contain `WM_SEC.AUTH_SIGNATURE`.

References 

https://gecgithub01.walmart.com/atyagi3/iamsignature/blob/master/SignatureGenerator.js

https://confluence.walmart.com/pages/viewpage.action?title=SOA+Header+Elements&spaceKey=PGPSOA

https://confluence.walmart.com/display/PGPSSO/Signing+headers+for+S2S+authentication

## Installing

```
npm install @walmart/iam-auth-signature --save
```

## Usage

This module exports one API

### [generateS2SAuthSignature](#generates2sauthsignature)

`function generateS2SAuthSignature(headers, privateKey, signList)`

Sign the header values specified by `signList` with privateKey.

  * `headers` - The HTTP headers to be signed.  You can just pass in the headers from HTTP request.
  * `privateKey` - A RSA private key in PEM format. [instructions on converting SOA key to PEM format](#converting-soa-private-key)
  * `signList` - An array of the header keys to sign.  
  
Returns

```
{
    signedParametersList: "header1;header2;"
    signatureVal: "<signed value>"
}
```

## Misc

### Converting SOA private Key

The private key from SOA portal is in a format `crypto` can't accept.

A script is provided to convert the SOA key to a RSA PEM key file using openssl.

To use it:

```
./soaKeyToPem.sh rsa-soa-private-key.pem
Please paste your SOA key and press ctrl+D
MIICdgIBADANBgkqhkiG9w0BAQEFAASCA<..... very long line .....>CRg==

writing RSA key
```

Now copy the `.pem` file generated to your application.

### Generating keys with openssl

A RSA private key can be generated with the `openssl` command.

```
$ openssl genrsa -out private-key.pem 1024
Generating RSA private key, 1024 bit long modulus
...++++++
.......++++++
e is 65537 (0x10001)
```

A RSA public key can be generated for a private key.

```
$ openssl rsa -in private-key.pem -outform PEM -pubout -out public-key.pem
writing RSA key
```

### Generating SOARI private key

SOARI consumer private key can be generated here:

QA: https://qaportal.walmart.com/web/platform/service-registration-tool  

PROD: http://app.prod.portal.platform.glb.prod.walmart.com/web/platform/service-registration-tool
