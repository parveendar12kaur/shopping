"use strict";

const _ = require("lodash");
const JsonPath = require("jsonpath");

function process(rules, ccm) {
  const uiCCM = {};

  const processPath = (path, regex) => {
    path.shift();
    const node = _.get(ccm, path);
    const uiNode = _.get(uiCCM, path) || {};

    _.each(regex, r => {
      _.each(node, (value, key) => {
        if (key.match(new RegExp(r))) {
          uiNode[key] = value;
        }
      });
    });

    _.set(uiCCM, path, uiNode);
  };

  _.each(rules, (regex, jsonPath) => {
    const paths = JsonPath.paths(ccm, jsonPath);
    _.each(paths, path => processPath(path, _.isArray(regex) ? regex : [regex]));
  });

  return uiCCM;
}

module.exports = {
  process
};
