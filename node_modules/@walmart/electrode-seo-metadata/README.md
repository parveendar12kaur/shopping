# electrode-seo-metadata

This module has two parts:

1. [`PageMetadata`](#pagemetadata) class for managing page metadata.  
   Determines what `<meta>` tags will be rendered by [electrode-react-webapp].

2. [Plugin](#plugin) to fetch seo and/or relm metadata from the
   [PEEPS](https://gecgithub01.walmart.com/labs-seo/peeps) service on each request.

## Support

Release notes are in [`CHANGELOG.md`](/CHANGELOG.md). To get help or report a
problem, [file an issue].

Maintainers: [@jwils98](https://gecgithub01.walmart.com/jwils98) [@awest5](https://gecgithub01.walmart.com/awest5)

## PageMetadata

`PageMetadata` is used by [electrode-react-webapp] to render metadata elements in
the page `<head>`.  
It **does not directly modify `<head>` or any page html**.

To influence what meta tags are rendered, add values before `electrode-react-webapp`
renders the `<head>` - that is, before your [`content`](https://gecgithub01.walmart.com/electrode/electrode-react-webapp#content-details)
resolves.

The methods that accept metadata - `addSource`, `set` and `setDefaults` - will each
log a warning message if used after head elements have already been determined.

`electrode-react-webapp` `v7.1.0` or above provides an instance at **`request.app.pageMetadata`**.

It can be used regardless of whether your app uses the `electrode-seo-metadata` plugin.

#### Client usage

`PageMetadata` can be used in client code to get metadata values, taking into account
all sources. See [constructor](#new-pagemetadataseodata-options) for details.

Note the above message - adding metadata after the head has been rendered will
have no effect on the page's html.

#### Configuration

Config is done through `electrode-react-webapp` config - see its [docs](https://gecgithub01.walmart.com/electrode/electrode-react-webapp#options).
The keys that can be used inside `metaTags.seo` are described below.

`metaTags.seoOptions.sourceOrder` configures [sources](#sources). `sourceOrder` should be
an array of source names, in priority order from highest to lowest. If `"defaults"`
is not included, it will be added to the end. _Requires `electrode-react-webapp@7.2.0` or above._

If you are instantiating `PageMetadata` directly, see [below](#new-pagemetadataseodata-options) for details on
how to pass in data/options.

#### Keys

The following keys are used to populate elements in the head:
  - `title`
  - `description`
  - `keywords`
  - `robots`
  - `canonical`, `canonicalPrev`, `canonicalNext`
  - `model`, `upc`
  - Keys starting with `twitter:`, `og:`, `fb:`, or `article:`

Some social media tags have default values:
- Hardcoded defaults: `twitter:card`, `twitter:image`, `twitter:site`, `fb:app_id`,
  `og:image`, `og:site_name`, `og:type` (see [`lib/page-metadata.js`](/lib/page-metadata.js))
- Based on corresponding generic key:
  - `twitter:description` (from `description`)
  - `og:title`, `twitter:title` (from `title`)
  - `og:url`, `twitter:url` (from `canonical`)

Other keys can be set and/or may be available depending on sources, but won't
affect `<head>` rendering.

#### Sources

##### Accepted sources

Always accepted: `peeps`, `defaults`

Additional valid sources are determined by your app's `sourceOrder` option - see
below.

##### `sourceOrder`

Two sources have a fixed position regardless of configuration:
- `peeps` is always first - internally inserted at the start of `sourceOrder`
- `presets` (internal set of hardcoded values) is always last - internally appended to `sourceOrder`

The order of sources in between can be configured with the `sourceOrder` option -
see [configuration](#configuration). Note that `"defaults"` is always supported -
it will be added to the end of your `sourceOrder` option if not included.

Default `sourceOrder`: `["iro", "preso", "defaults"]` (highest -> lowest priority)

#### `new PageMetadata(seoData, options)`

- `seoData` - optional object with sourceName-sourceData key value pairs.
  This data can also be passed in after instantiation with [`.addSource`](#addsource)
- `options` - optional object. Currently, the only available option is [`sourceOrder`](#sourceorder).

Usage:

In server code, you don't need to create an instance; `electrode-react-webapp` `v7.1.0`
or above provides one at `req.app.pageMetadata`. Rather than passing the above
arguments directly, you set them in your react-webapp [config](#configuration).

In client code, a new instance may be useful to get metadata values that take all
sources into account.

All seo metadata compiled on the server is serialized and made available for the client:

- In React component, during SSR: `this.context.seoTags` (provided by `redux-router-engine`)
- In browser: `window._wml.seoTags` (provided by `electrode-react-webapp`)

Example:

```js
import ExEnv from "exenv";
import { PageMetadata } from "@walmart/electrode-seo-metadata";

// inside a component:
const seoTags = ExEnv.canUseDOM ? window._wml.seoTags : this.context.seoTags;
const pageMetadata = new PageMetadata(seoTags);
```

#### `.get(key)`

Returns the value for the given key, or `undefined` if no value is stored.

When there are multiple values for a given key, the one from the highest priority
source is returned (see [source order](#sourceorder) above).

_Note: Data from the PEEPS service is fetched asynchronously.  To guarantee that
PEEPS data is applied when calling `.get`, you can use [`.onPeepsData`](#onpeepsdata)._

#### `.set(key, value)`

Set a default value for the given key. To set several at once, use `setDefaults`.

#### `.setDefaults(defaults)`

Set multiple defaults at once.

#### `.addSource(source, data)`

Add seo data from an external source. Returns a boolean indicating whether it
was successful. (Unconfigured sources cannot be added - see [accepted sources](#acceptedsources))

- `source`: _string_ name of the source
- `data`: _object_ seo metadata - see [keys](#keys)

Example usage:
```js
module.exports = reduxRouterEngine(routes, function (req) {
  var store = configureStore();

  return Promise.all([
    // actions that include a preso fetch
    store.dispatch(bootstrapSearch(req))
  ]).then(function () {
    // now that preso fetch has completed, store the results
    req.pageMetadata.addSource("preso", store.getState().preso);
    return store;
  });
});
```

#### `.onPeepsData()`

Returns a promise that resolves once the call to the peeps service (initiated by
the [plugin](#plugin)) has completed. Can be used to avoid getting incomplete data
while a peeps call is pending.

If no peeps call was made, it will resolve immediately.

Example usage:
```js
req.app.pageMetadata.onPeepsData()
  .then(() => {
    // these are guaranteed to include peeps data if applicable
    const cwc = req.app.pageMetadata.get("cwc");
    const title = req.app.pageMetadata.get("title");
  });
```

## Plugin

The plugin will automatically fetch data for the following page types:

Page type\* | seo | relm
------------|:---:|:----:
Item        |     | ✓
Browse      |  ✓  | ✓
Category    |  ✓  | ✓
Topic       |  ✓  |
Store topic |  ✓  |
Brand       |  ✓  |
Marketing   |  ✓  |

\*For details on how these types are defined, see the source code:
[seo](/lib/metadata-fetch.js), [relm](/lib/relm-fetch.js).

### Setup

Install: `npm install --save @walmart/electrode-seo-metadata`

Enable by adding this line to your app's config, under `plugins`:
```js
"@walmart/electrode-seo-metadata": {}
```

### Accessing seo data

In server code, you can access the computed value for each metadata field using
`request.app.pageMetadata`. See [above](#pagemetadata) for details.

On the client, see [`PageMetadata` constructor](#new-pagemetadataseodata-options).

### Accessing relm data

- In server code: `req.app.relm`
- In browser: `window._wml.relm`

---

## More info

### Integration with `electrode-react-webapp`

`electrode-react-webapp` uses `PageMetadata` when rendering the page `<head>`

1. It creates an instance using the data it has so far: `request.app.seoTags` and
  `electrode-react-webapp` config.
2. The instance is stored at `request.app.pageMetadata`, so application code can
  add/update metadata before the `<head>` is rendered (see [above](#pagemetadata)).
3. The `Index` component in `electrode-react-webapp` uses `pageMetadata` to
  add metadata-related (mainly `<meta>`) elements to the `<head>`.


### Requirements

Walmart currently uses a SEO service to provide dynamic headers to category,
item, browse, and topic pages. Topic pages are manually and algorithmically
generated for consumption by search engines.

Here are a few example endpoints.</br>
Category: http://api.meta-data.glb.prod.walmart.com/category_page_content/__/3944</br>
Item page: http://api.meta-data.glb.prod.walmart.com/item_page_content/__/30146246</br>
Browse page: http://api.meta-data.glb.prod.walmart.com/browse_page_content/__/3944_1060825_447913</br>
Topic page: http://api.meta-data.glb.prod.walmart.com/topic_meta/__/mini-fridge</br>
Brand page: http://api.meta-data.glb.prod.walmart.com/brand_page_meta/__/applause</br>
Marketing page: http://api.meta-data.glb.prod.walmart.com/marketing_page_meta/__/testing</br>

The meta-data endpoint is part of the PEEPS project which can be found [here](https://gecgithub01.walmart.com/labs-seo/peeps).

#### Sample endpoint content
```js
{
	"metaKW": "electronics, electronic products, tablets, TVs, laptops, hdtv",
	"leftNav": "<div id = 'LeftNavCreate'><ul class='NoBullet' style=\"padding-top: 5px\">\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/sceptre-tvs'>\n              Sceptre TVs\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/vesa-wall-mounts'>\n              Vesa Wall Mounts\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/samsung-smart-tv-led'>\n              Samsung Smart TV - Led\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/dvd-vhs-players'>\n              DVD & VHS Players\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/inkjet-printers'>\n              Inkjet Printers\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/tp/tablets-for-kids'>\n              Tablets for Kids\n          </a>\n\n</li>\n<li class='catPop' style=\"padding-top: 9px\"> <a href='http://www.walmart.com/c/kp/canon-powershot-cameras'>\n              Canon Powershot Cameras\n          </a>\n\n</li>\n</ul></div>",
	"metaDesc": "Shop for the best electronics, like computers, laptops, tablets, tv electronics, cell phones, home theaters and much much more. Save money. Live better. Walmart.com.",
	"metaTitle": "Electronics - TVs, Cameras, Tablets, Computers & More - Walmart.com",
	"leftNavTitle": "Popular in Electronics",
	"cwc": "<b>Electronics</b><p>Whether you're upgrading to a new or <a href=\"http://www.walmart.com/browse/electronics/refurbished-laptops/3944_3951_1089430_1230091_1230092\">refurbished laptop</a>, looking for sleek new accessories for your phone or <a href=\"http://www.walmart.com/browse/electronics/apple-ipod-touch/3944_96469_1089089\">iPod</a> or shopping for a new HDTV, Walmart makes it easy to find what you need at a price you can afford.<p>If you're looking for a new <a href=\"http://www.walmart.com/cp/computers/3951\" title=\"computers\" target=\"_self\">computer</a>, consider the speed and processing power you need and the best screen size for your use. Single and dual core processors are good for basic functions like email and web browsing, but you'll want a quad-core computer if you do a lot of gaming or video streaming. An <a href=\"http://www.walmart.com/browse/electronics/tablet-pcs/3944_3951_1078084\" title=\"iPads and Tablets\" target=\"_self\">iPad or tablet</a> is a great option for computing on the go, and a <a href=\"http://www.walmart.com/browse/electronics/touchscreen-laptops/3944_3951_1101633\" title=\"touchscreen laptops\" target=\"_self\">touchscreen laptop</a> gives you the benefits of a tablet with the option of using a keyboard.<p>When shopping for a <a href=\"http://www.walmart.com/cp/televisions-video/1060825\" title=\"TVs\" target=\"_self\">TV</a>, consider your available space, the resolution and refresh rate you want, and whether you want to watch 3D content or connect to the Internet. Higher resolution TVs have a clearer picture, and TVs with high refresh rates give you smoother motion. <a href=\"http://www.walmart.com/browse/electronics/smart-tvs/3944_1060825_1229815_1229817\" title=\"smart TVs\" target=\"_self\">Smart TVs</a> let you stream directly from the Internet, and <a href=\"http://www.walmart.com/browse/electronics/3d-tvs/3944_1060825_1229815_1229819\" title=\"3D TVs\" target=\"_self\">3D TVs</a> let you watch 3D video at home.<p>For extra savings, you may want to consider refurbished devices, which are mostly returns from customers who have never used them. You call also search for special offers, such as Rollbacks or Clearance.<p>Walmart.com lets you sort electronics by price, customer rating or features, so finding the right device for you is a breeze. Save money. Live better."
}
```
[electrode-react-webapp]: https://gecgithub01.walmart.com/electrode/electrode-react-webapp#electrode-react-webapp
[file an issue]: https://gecgithub01.walmart.com/electrode/electrode-seo-metadata/issues/new
