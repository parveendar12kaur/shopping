{"version":3,"sources":["../src/page-metadata.js"],"names":["get","require","omit","each","isString","isObject","includes","isFunction","cloneDeep","isNil","toLower","map","concat","defaults","without","elementUtils","MAP_SERVICE_KEYS","pageTitle","pageTitleSuffix","peeps","metaDesc","metaTitle","metaKW","header","noIndex","preso","PRESETS","DEFAULT_SOURCE_ORDER","PageMetadata","seoData","options","_sources","presets","_pending","_setSourceOrder","headSent","_logger","logger","undefined","hasOwnProperty","addSource","data","source","_refresh","skipRefresh","msg","toLowerCase","sourceOrder","knownSources","then","_peepsPromise","resolvedData","catch","err","_warnHeadSent","value","serviceKey","key","reflect","return","Promise","resolve","_metadata","def","val","set","elements","info","getElementInfo","push","elementType","getElementType","_updateSocialTags","sourceOrderOption","canonical","description","title","module","exports"],"mappings":"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","file":"page-metadata.js","sourcesContent":["\"use strict\";\n\n/* eslint-disable max-statements */\n\nconst get = require(\"lodash/get\");\nconst omit = require(\"lodash/omit\");\nconst each = require(\"lodash/each\");\nconst isString = require(\"lodash/isString\");\nconst isObject = require(\"lodash/isObject\");\nconst includes = require(\"lodash/includes\");\nconst isFunction = require(\"lodash/isFunction\");\nconst cloneDeep = require(\"lodash/cloneDeep\");\nconst isNil = require(\"lodash/isNil\");\nconst toLower = require(\"lodash/toLower\");\nconst map = require(\"lodash/map\");\nconst concat = require(\"lodash/concat\");\nconst defaults = require(\"lodash/defaults\");\nconst without = require(\"lodash/without\");\n\nconst elementUtils = require(\"./page-element-utils\");\n\nconst MAP_SERVICE_KEYS = {\n  defaults: {\n    pageTitle: \"title\",\n    pageTitleSuffix: \"titleSuffix\"\n  },\n  peeps: {\n    metaDesc: \"description\",\n    metaTitle: \"title\",\n    metaKW: \"keywords\",\n    header: \"genericHeader\",\n    noIndex: \"robots\"\n  },\n  preso: {\n    noIndex: \"robots\"\n  }\n};\n\nconst PRESETS = {\n  \"og:type\": \"Website\",\n  \"og:image\": \"http://sphotos-b.xx.fbcdn.net/hphotos-ash4/229244_10150189115584236_162217_n.jpg\",\n  \"og:site_name\": \"Walmart.com\",\n  \"fb:app_id\": \"105223049547814\",\n  \"twitter:card\": \"summary\",\n  \"twitter:image\": \"https://pbs.twimg.com/profile_images/616833885/walmart_logo_youtube_bigger.jpg\",\n  \"twitter:site\": \"@walmart\"\n};\n\nconst DEFAULT_SOURCE_ORDER = [\"iro\", \"preso\", \"defaults\"];\n\nclass PageMetadata {\n  constructor(seoData, options) {\n    this._sources = { presets: PRESETS, defaults: {} };\n    this._pending = {};\n    this._setSourceOrder(get(options, \"sourceOrder\"));\n    this.headSent = false;\n    this._logger = options && options.logger ? options.logger : () => undefined;\n\n    if (options && !options.hasOwnProperty(\"sourceOrder\")) {\n      options = omit(options, [\"logger\"]);\n      // support earlier versions where defaults were passed as second param\n      this.addSource(\"defaults\", options, true);\n    }\n\n    each(seoData, (data, source) => this.addSource(source, data, true));\n\n    this._refresh();\n  }\n\n  static getElementType(key) {\n    return elementUtils.getElementType(key);\n  }\n\n  addSource(source, data, skipRefresh) {\n    // eslint-disable-line max-statements\n    if (!isString(source) || !isObject(data)) {\n      if (!skipRefresh) {\n        const msg = isString(source)\n          ? `data for \"${source}\" - expected object, got ${typeof data}`\n          : `source name - expected string, got ${typeof source}`;\n        this._logger([\"warn\"], `addSource received invalid ${msg}`);\n      }\n      return false;\n    }\n    source = source.toLowerCase();\n\n    if (!includes(this.sourceOrder, source)) {\n      this._logger([\"warn\"], {\n        msg: \"Unrecognized seo metadata source cannot be added\",\n        knownSources: this.sourceOrder,\n        source\n      });\n      return false;\n    }\n\n    if (isFunction(data.then)) {\n      if (source === \"peeps\") {\n        this._peepsPromise = data;\n      }\n      return data.then(resolvedData => this.addSource(source, resolvedData)).catch(err => {\n        this._logger([\"warn\"], { msg: \"Page metadata source rejected\", source, err });\n      });\n    }\n\n    this._warnHeadSent(source);\n\n    this._sources[source] = {};\n    each(data, (value, serviceKey) => {\n      const key = get(MAP_SERVICE_KEYS, [source, serviceKey], serviceKey);\n\n      if (serviceKey === \"noIndex\") {\n        value = value ? \"noindex\" : \"\";\n      }\n      this._sources[source][key] = value;\n    });\n\n    if (!skipRefresh) {\n      this._refresh();\n    }\n    return true;\n  }\n\n  onPeepsData() {\n    return this._peepsPromise ? this._peepsPromise.reflect().return() : Promise.resolve();\n  }\n\n  get(key) {\n    return get(this._metadata, key);\n  }\n\n  set(key, value, skipRefresh) {\n    this._sources.defaults[key] = value;\n    if (!skipRefresh) {\n      this._warnHeadSent(\"defaults\");\n      this._refresh();\n    }\n  }\n\n  setDefaults(def) {\n    each(def, (val, key) => {\n      this.set(key, val, true);\n    });\n    this._warnHeadSent(\"defaults\");\n    this._refresh();\n  }\n\n  getSourceData() {\n    return cloneDeep(this._sources);\n  }\n\n  getHeadElements() {\n    const elements = [];\n    each(this._metadata, (value, key) => {\n      const info = this.getElementInfo(key);\n      if (info) {\n        elements.push(info);\n      }\n    });\n    this.headSent = true;\n    return elements;\n  }\n\n  getElementInfo(key) {\n    if (!key) {\n      return null;\n    }\n    let value = this.get(key);\n    if (!value) {\n      return null;\n    }\n    if (key === \"title\") {\n      value += this.get(\"titleSuffix\") || \"\";\n    }\n    const elementType = elementUtils.getElementType(key);\n    return elementUtils.getElementInfo(elementType, key, value);\n  }\n\n  _refresh() {\n    this._metadata = {};\n    each(this.sourceOrder, source => {\n      each(this._sources[source], (value, key) => {\n        if (isNil(this._metadata[key])) {\n          this._metadata[key] = value;\n        }\n      });\n    });\n    this._updateSocialTags();\n  }\n\n  _setSourceOrder(sourceOrderOption) {\n    if (sourceOrderOption) {\n      sourceOrderOption = without(map(sourceOrderOption, toLower), \"peeps\", \"presets\");\n      if (!includes(sourceOrderOption, \"defaults\")) {\n        sourceOrderOption.push(\"defaults\");\n      }\n    }\n\n    this.sourceOrder = concat(\"peeps\", sourceOrderOption || DEFAULT_SOURCE_ORDER, \"presets\");\n  }\n\n  _updateSocialTags() {\n    if (this._metadata.canonical) {\n      defaults(this._metadata, {\n        \"twitter:url\": this._metadata.canonical,\n        \"og:url\": this._metadata.canonical\n      });\n    }\n    if (this._metadata.description && !this._metadata[\"twitter:description\"]) {\n      this._metadata[\"twitter:description\"] = this._metadata.description;\n    }\n    if (this._metadata.title) {\n      defaults(this._metadata, {\n        \"og:title\": this._metadata.title,\n        \"twitter:title\": this._metadata.title\n      });\n    }\n  }\n\n  _warnHeadSent(source) {\n    if (this.headSent) {\n      this._logger([\"warn\"], {\n        msg: \"Received seo metadata after head elements were rendered\",\n        source\n      });\n    }\n  }\n}\n\nmodule.exports = PageMetadata;\n"]}