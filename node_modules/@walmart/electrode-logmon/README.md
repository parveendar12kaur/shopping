# logmon

A Logmon client for node.js. Originally based off of [platform-node/logmon](https://gecgithub01.walmart.com/platform-node/logmon).

## Setup

```
npm install --save @walmart/electrode-logmon
```

## Usage

```js
var Logmon = require("logmon");

var logmon = new Logmon();

logmon.write({
  payload: {
    "applog.msg": "Lorem ipsum dolor sit amet",
    foo: 123,
    bar: {
      baz: 456
    }
  },
  type: "DEBUG"
});
```

### `Logmon.getTxIdSync(options)`

_Static method_

Generates a transaction id synchronously. See below for the async counterpart, which does require a `Logmon` instance.

- `[options]` *(Object)*: an object with values to be formatted in the transaction ID;
    - `[clientId]` *(Number)*: a 32-bit integer returned by `getClientId`, defaults to a random number;
    - `[threadId]` *(Number)*: the thread/process ID, defaults to the current process ID;
    - `[timestamp]` *(Number)*: the timestamp in milliseconds, defaults to the current time;
    - `[sequence]` *(Number)*: a 12-bit integer, defaults to a random number.

### `new Logmon([options])`

Creates a LogMon client instance.

- `options` *(Object)*: a configuration object;
    - `[appId]` *(String)*: the application ID, it defaults to _{ONEOPS_ASSEMBLY}-{ONEOPS_PLATFORM}_;
    - `[buildId]` *(String)*: the build ID/version;
    - `[dataCenter]` *(String)*: the data-center ID, it defaults to the environment variable _{ONEOPS_CLOUD}_;
    - `[environment]` *(String)*: the environment ID, it defaults to the environment variable _{ONEOPS_ENVIRONMENT}_;,
    - `[filePath]` *(String)*: the log file path, defaults to _/log/logmon/logmon_new.log_. *Important*: the parent directory must exist and the current process must have permission to write to it;
    - `[groupId]` *(String)*: defaults to _{ONEOPS_ASSEMBLY}_;
    - `[host]` *(String)*: defaults to _{ONEOPS_CI_NAME}_, falls back to the hostname provided by the OS;
    - `[maxSize]` *(Number)*: maximum file size before rolling, defaults to `104857600` (100 MB);
    - `[mode]` *(Number)*: sets the writer mode, supported values are `1` (file), `2` (kafka) and `3` (dual). It defaults to `3`;
    - `[zookeeper]` *(String)*: the connection string for **Apache Zookeeper** servers, defaults to `dare-msgq00.sv.walmartlabs.com:9091,dare-msgq01.sv.walmartlabs.com:9091,dare-msgq02.sv.walmartlabs.com:9091` (QA). [See also](https://github.com/SOHU-Co/kafka-node/blob/master/README.md);
    - `[emitErrors]` *(Boolean)*: whether to re-emit errors from file and/or kafka writers. When setting this to true, make sure to [add a listener](#onerror-handler) for the error event. Defaults to `false`.

### `write(data, [callback])`

Writes data into the log file and/or the Apache Kafka broker, depending on the selected mode.

- `data` *(Object)*: an object containing the data to be logged;
    - `[category]` *(String)*: the resource ID;
    - `[duration]` *(Number)*: optional, call duration in milliseconds;
    - `[epoch]` *(Number)*: timestamp in milliseconds, defaults to `Date.now()`;
    - `[level]` *(Number)*: transaction nesting level;
    - `[parentTxId]` *(String)*: parent transaction ID, see [LogMon GUID](https://confluence.walmart.com/pages/viewpage.action?pageId=27789604);
    - `[payload]` *(Object)* : to be serialized for LogMon consumption, some keys are reserved:
        - `[applog.msg]`: free-form text, see [LogMon documentation](https://confluence.walmart.com/display/PGPLOGMON/Documentation);
        - `[tx.status]` *(String)*: optional, `0` if the transaction succeed, otherwise `-1`;
    - `[sessionId]` *(String)*: the web session ID,
    - `[subType]` *(String)*: event sub-type, supported values are `P-START`, `P-END`, `C-START`, `C-END`, `R-START` and `R-END`;
    - `[timestamp]` *(String)*: formatted timestamp: _YYYY-MM-DD HH:mm:ss.SSS_;
    - `[topTxId]` *(String)*: top transaction ID, see [LogMon GUID](https://confluence.walmart.com/pages/viewpage.action?pageId=27789604);
    - `[txId]` *(String)*: optional, transaction ID, see [LogMon GUID](https://confluence.walmart.com/pages/viewpage.action?pageId=27789604);
    - `[type]` *(String)*: event type, supported values are `AUDIT`, `DEBUG`, `ERROR`, `EVENT`, `HB`, `INFO`, `WARN` and `TN`;
- `callback` *(Function)*: optional, returns an error, if occurred, should implement `function(error)` interface.

### `getClientId(callback)`

Returns the client ID for the current LogMon instance.

- `callback` *(Function)*: the callback function should implement `function(error, clientId)` interface.

### `getTxId(options, callback)`

Generates a transaction ID from the given options. Makes a call to `getClientId`. See [LogMon GUID](https://confluence.walmart.com/pages/viewpage.action?pageId=27789604).

- `options` *(Object)*: an object with values to be formatted in the transaction ID;
    - `[threadId]` *(Number)*: the thread/process ID, defaults to the current process ID;
    - `[timestamp]` *(Number)*: the timestamp in milliseconds, defaults to the current time;
    - `[sequence]` *(Number)*: a 12-bit integer, defaults to a random number;
- `callback` *(Function)*: returns the result, should implement `function(error, txId)` interface.

### `on("error", handler)`

Listen for error events. By default, none are emitted. When `options.emitErrors` is true, the logmon instance will re-emit all errors it receives from its file and/or kafka writers.

If there is no listener registered and an error is emitted, it will throw (see [`EventEmitter` docs](https://nodejs.org/api/events.html#events_error_events)).

## External resources

- [LogMon Confluence](https://confluence.walmart.com/display/PGPLOGMON);
- [BFD Kafka Deployment](https://confluence.walmart.com/display/PGPBFDOPS/Kafka+Host+Details).

## Verifying Messages in Hive

The following information is based on the support ticker [PGPLOGMON-3303](https://jira.walmart.com/browse/PGPLOGMON-3303)

- You will first need access to the `cdc-main` Hadoop cluster [[request access](https://bfdops.walmartlabs.com/portal.php)]
- [Log Search Use Cases](https://confluence.walmart.com/display/~schakr5/Hive+queries+for+LogSearch+UseCases)

### Example Query

```shell
$ time TZ=US/Pacific ./updated.sh <ASSEMBLY>-<PLATFORM> dev '2015-07-21 00:00' '2015-07-21 11:00' "SELECT * FROM_RAW_LOGMON"
```
