canary
======

Create analytic engines that can run anywhere.

For a high level summary of the Canary ecosystem, see the [Canary Confluence page](https://confluence.walmart.com/display/PGPANALYTICS/Canary).

<!-- TOC -->
- [example](#example)
- [api](#api)
  - [application api](#application-api)
    - [var canary = createCanary([options])](#var-canary--createcanaryoptions)
    - [canary.applyRules( [rule1, rule2, ...] [, options])](#canaryapplyrules-rule1-rule2---options)
    - [canary.suspend()](#canarysuspend)
    - [canary.resume()](#canaryresume)
    - [canary.message(cb)](#canarymessagecb)
    - [canary.log(cb)](#canarylogcb)
    - [canary.process(payload)](#canaryprocesspayload)
    - [canary.state.registerStore(store [, arg1, arg2, ...])](#canarystateregisterstorestore--arg1-arg2-)
    - [canary.state.unregisterStore(name)](#canarystateunregisterstorename)
    - [canary.state.isStoreAvailable(name)](#canarystatestoreavailablename)
    - [canary.state.setDefaultStore(name)](#canarystatesetdefaultstorename)
    - [canary.state.getDefaultStore()](#canarystategetdefaultstore)
    - [canary.state.configure(configModule [, arg1, arg2, ...])](#canarystateconfigureconfigmodule--arg1-arg2-)
    - [canary.rules](#canaryrules)
  - [rule api](#rule-api)
    - [canary.event(cb)](#canaryeventcb)
    - [canary.event.getHistory(n)](#canaryeventgethistoryn)
    - [canary.dispatch(messageObject)](#canarydispatchmessageobject)
    - [canary.state.set(key, value [, options])](#canarystatesetkey-value--options)
    - [canary.state.get(key [, options])](#canarystategetkey--options)
    - [canary.state.remove(key [, options])](#canarystateremovekey--options)
- [supporting modules](#supporting-modules)
- [install](#install)
  - [scope](#scope)
- [testing](#testing)
  - [coverage](#coverage)

<!-- TOC END -->

## example

_main.js_ (with dynamic rule loading via Canary web service)

```javascript
var canary = require('@walmart/canary')();

// Require the package that loads Canary assets from the Canary Web Service
var loadRules = require('@walmart/canary-loader');

// Load the 'hello-world' asset from the Canary Web Service
loadRules('hello-world').then(canary.applyRules);

// Send analytics produced by Canary somewhere
canary.message(/* delivery adapter here */);
// also log outbound analytics
canary.message(console.log);

// And if we want to print canary logs to our console, we could do this:
canary.log(console.log);

// start feeding canary data
canary.process(/* object */);
canary.process(/* object */);
// etc...
```

_main.js_ (loading rules locally)

```javascript
var canary = require('@walmart/canary')();
var rules = require('./rules.js');

// load the rule into our canary
canary.applyRules(rules);

// Send analytics produced by Canary somewhere
canary.message(/* delivery adapter here */);
// also log outbound analytics
canary.message(console.log);

// And if we want to print canary logs to our console, we could do this:
canary.log(console.log);

// start feeding canary data
canary.process(/* object */);
canary.process(/* object */);
// etc...

var global = require('global-object');
var canary = require('@walmart/canary')();
var rules = require('./rules.js');
```

_rules.js_

```javascript
module.exports = [

    // define a rule that sends every single event we get to Anivia (not the best idea)
    function echoRule (canary) {

        canary.event(function onEvent (payload) {

            canary.dispatch(payload);
        });
    }
];
```

## api

```javascript
var createCanary = require('@walmart/canary');
```

### application api

The following interfaces are intended to be used by the application, in order to interface properly with Canary.

#### var canary = createCanary([options])

Create a new Canary object, `canary`. 

Valid `options` are:
* `historySize` (default: 100) - Control how many historical events Canary will
  keep in its event ring buffer. This will impact sequence pattern matching;
  increasing this will allow patterns to be identified that include more than
  100 (even unmatched) events, while reducing it will have the opposite effect.
* `processBufferMax` (default: 1000) - This dictates the maximum number of
  events to buffer while processing is suspended (see `canary.suspend`). You can
  disable buffering completely by setting this to 0.
* `suspend` (default: `true`) - Start Canary in a suspended state by default,
  during which time, any messages received will be queued until Canary is
  resumed via `applyRules` (or `resume`).

#### canary.applyRules( [rule1, rule2, ...] [, options])

Accepts a single array of rules to be applied to events. Each rule function is 
executed one time, when `applyRules` is called, and is responsible for setting 
up whatever event handlers it needs to process future events. The rule function 
is passed the `canary` object. 

Optionally accepts an `options` object. Valid options are:

* `resume` (default:`true`) - By default, `resume` will be called once rules
  have been applied. Override this behaviour on this `applyRules` call by
  setting this to `false`.

#### canary.suspend()

Manually suspend event processing. If buffering is enabled (see
`processBufferMax` under `createCanary` options), then incoming events will be
buffered. If more than `processBufferMax` have been received, older events will
be dropped from the buffer to make room for newer events.

If `processBufferMax` is set to zero, then any incoming events will be lost
while `canary` is suspended.

#### canary.resume()

Resume processing of events. Any buffered events will be processed immediately.

#### canary.message(cb) 

An eventuate representing analytic messages produced by the `canary`. Accepts a callback to be executed for each analytic message produced. The callback is passed the message, in stringified form, as it's only argument. 

#### canary.log(cb)

An eventuate representing log messages from the `canary`. Accepts a callback to be executed for each log message produced. The callback is passed the message, as a string.

#### canary.process(payload)

Instruct canary to process an event. Requires a `payload`, which may be stringified JSON, or a Javascript object. The `canary.event` eventuate will produce this payload.

#### canary.state.registerStore(store [, arg1, arg2, ...])

Register a store with the Canary subsystem. Any additional arguments are passed
to the store function when it's initialized. 

The `store` argument should be a function that returns a store object in the
following format:

```
{
    name: '',
    set: function (k, v, opts) {},
    get: function (k, opts) {},
    remove: function (k, opts) {}
}
```

#### canary.state.unregisterStore(name)

Unregister a store from the Canary subsystem. Requires `name` of the store.

#### canary.state.isStoreAvailable(name)

Returns `true` if the store identified by `name` is available, otherwise
`false`.

#### canary.state.setDefaultStore(name)

Set the store, by `name`, that is used for `set`, `get`, `remove`, when the
store is not explicitly declared via the `in` option.

#### canary.state.getDefaultStore()

Return the name of the default store.

#### canary.state.configure(configModule [, arg1, arg2, ...])

Canary state configuration modules, such as `@walmart/canary-browser-storage`,
may be passed to the `canary.state.configure` function. This allows one or more
stores to be configured at once, as well as other settings (such as default
store, etc).

The `configModule` should be a function that returns a configuraion object in
the following format:

```
{
    stores: [],
    defaultStore: ''
}
```

All keys are optional. Any additional arguments beyond `configModule` to the
`configure` function are passed to the `configModule` function when it's
invoked.

#### canary.rules

An array of active rules (provided via `applyRules`).

### rule api

#### canary.event(cb)

An [eventuate](https://www.npmjs.com/package/eventuate) representing application events. Accepts a callback to be executed for each event received from the application. The callback is passed an event payload object.

#### canary.event.getHistory(n)

Return an array of the last `n` events that have been processed by the Canary. 
If `n` is ommitted, all events will be returned (limited by the `historySize`
option specified at canary creation time). Newer events are at the beginning of 
the array.

#### canary.dispatch(messageObject)

Instruct the `canary` to send the `messageObject` to Anivia. 

#### canary.state.set(key, value [, options])

Associate a `value` with a `key`, to be retrieved later with `canary.state.get`. 
Valid options include: `in`, and `ttl`. Certain stores may accept additional
options. 

By default, Canary will store state in the `memory` store, which means state is
lost once that memory is deallocated. Applications may provide additional state
stores that offer longer retention and more durability. Each such store has an
identifier which may be targeted by passing the `in` option. For example:

```javascript
canary.state.set('key', 'value', { in: 'sessionStorage' });
```

Applications may change the default store; consult with your application
documentation to determine what state options you have available.

If a `ttl` is provides, then Canary.state will expire the key (on read) once a
number of milliseconds have lapsed equal to `ttl` since the `key` was set.
Certain stores may be able to invalidate the key prior to read, but Canary
offers expire-on-read as a fallback.

#### canary.state.get(key [, options])

Return a value previously associated with the provided `key`. Valid options
include: `in`. 

The `in` option may be specified to dictate which backing store the key should
be retrieved form, see `canary.state.set` above for additional information.

#### canary.state.remove(key [, options])

Remove a key previously set. Valid options include: `in`. 

The `in` option may be specified to dictate which backing store the key should
be retrieved form, see `canary.state.set` above for additional information.

## supporting modules

* [canary-event-pattern](https://gecgithub01.walmart.com/canary/canary-event-pattern) - match canary events using patterns
* [canary-event-sequence](https://gecgithub01.walmart.com/canary/canary-event-sequence) - match sequences of events using patterns

## install

```sh
npm install --save @walmart/canary
```

### scope

Before using this module in your project, be sure to set the `@walmart` scope to point to `npme.walmart.com`. 
We suggest adding the following lines to the `.npmrc` file in your project's root:

```
strict-ssl=false
@walmart:registry=https://npme.walmart.com
```

## testing

`npm test`

To continuously run tests as you work: `npm run watch`

To run tests in phantom: `npm run phantom`

### coverage

`npm run view-cover`

This will output a textual coverage report.

`npm run open-cover`

This will open an HTML coverage report in the default browser.
