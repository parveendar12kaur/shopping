# Electrode Swapi

Standardizing mid-tier platform service clients

-   [Overview](#overview)
-   [Consuming a Swapi Client](#consuming-a-swapi-client)
-   [Usage](#usage)
-   [Swapi Clients](#swapi-clients)
    -   [Sample client:](#sample-client)
-   [WalmartLabs extensions](#walmartlabs-extensions)
    -   [x-wm-sign-headers](#x-wm-sign-headers)
    -   [x-wm-optional-params](#x-wm-optional-params)
-   [Optional Headers](#optional-headers)
-   [Static Methods](#static-methods)
    -   [`static` create](#static-create)
    -   [`static` createSwagger](#static-createswagger)
    -   [`static` swaggerWithFilename](#static-swaggerwithfilename)
    -   [`static` swaggerWithSpec](#static-swaggerwithspec)
    -   [`static` swaggerWithUrl](#static-swaggerwithurl)
    -   [`static` supportKeepAlive](#static-supportkeepalive)
    -   [`static` getClient](#static-getclient)
-   [Methods](#methods)
    -   [constructor](#constructor)
    -   [validateModel](#validatemodel)
    -   [addPasswordAuth](#addpasswordauth)
    -   [addApiKeyAuth](#addapikeyauth)
    -   [invokeWithMeta](#invokewithmeta)
    -   [invoke](#invoke)
    -   [withMeta](#withmeta)
-   [Properties](#properties)
    -   [name](#name)
    -   [swagger](#swagger)
    -   [operations](#operations)
    -   [WM_HEADERS](#wm_headers)

## Overview

Electrode Swapi is a module aim to standardize the implementation of mid-tier platform service NodeJS clients.  It will help you create a client for a service with REST APIs, by consuming a [swagger] spec file.  It helps you with initializing the spec file that you created.

This module uses Promise ([bluebird]) and [ES6 features NodeJS supports by default][node-es6].  That means NodeJS version 4.x or later (currently LTS 4.2.x).

The goals of standardizing service clients are:

1.  By consuming service APIs with Swagger spec, we establish a consistent approach and interface to calling services.

2.  The Swagger spec serves as both document and the API, so document is updated automatically as development is done.

    -   Swagger has a lot of great tools for developing and testing the spec

3.  Since all service invokes goes through this module, we can add standard processing such as:

    -   WalmartLabs SOARI headers, environment and registry handling, and service to service auth

    -   Instrumenting every service call, in order to:
        -   Easily find the number of service calls an app makes.
        -   Calculate service call failures, retries, and average or 95% timings.

## Consuming a Swapi Client

More details about consuming a swapi client (instead of creating one) can be found in [CONSUMING_SWAPI_CLIENT](CONSUMING_SWAPI_CLIENT.md)

## [Usage](#usage)

Install:

```bash
npm install @walmart/electrode-swapi --save
```

## Dependencies

Every time Swapi makes a service call it initiates a Logmon transaction log.  Electrode initially supports a
generic transaction API in [electrode-logging] using [continuation-local-storage].  Due to stability issue, [continuation-local-storage] is deprecated, but Swapi supports both in the same version.

A new module [electrode-log-transaction] is created to support transaction log without CLS.  Swapi tries to load
that with [optional-require].  If your app is using CLS less logging, then [electrode-log-transaction] should be
installed as part of your app's dependencies.  Swapi will automatically use this module to do transaction log if
it's available.

If your app is still dependent on CLS based logging, then your [electrode-logging] version 2 should be part of your
app's dependencies.  Swapi specifies a `peerDependencies` on either version 2 or 3 of [electrode-logging], but it
expects version 2 installed if [electrode-log-transaction] is not found.

## [Swapi Clients](#swapi-clients)

An Electrode Swapi based client is a class that inherits the ElectrodeSwapi class.

Typically, it just needs to provide some `static` information about the service it's for:

-   `specFilename` - return the full path to the swagger spec file
-   `providerName` - returns the name the client instance is expected to name in an Electrode app
-   `serviceName` - return the name of the service the client is for
-   `serviceVersion` - return the version of the service the client is for
-   `signHeadersList` - return an array of the header fields that should be signed for service to service auth.  This is needed only if S2S auth is required for the service.

Optionally, the client can provide a static factory method `create` with the following signature:

`create(config, [specOverride], [providerName])`

Where:

-   `config` - configuration object
-   `specOverride` - object with `host` or `basePath` to override what's in the spec
-   `providerName` - a different providerName to make the client instance available as

### Sample client:

Here is an example client.

```js
"use strict";

const ElectrodeSwapi = require("electrode-swapi");

class SampleClient extends ElectrodeSwapi {
  constructor(config, swagger, providerName) {
    super(config, swagger, providerName);
  }

  //
  // optional factory method
  //
  static create(config, specOverride, providerName) {
    return ElectrodeSwapi.create({Client: SampleClient, config, specOverride, providerName});
  }

  //
  // required standard static properties
  // This allows service initializer to create an instance of your
  // client and make it available in request.app.services[providerName]
  //
  static get specFilename() {
    return Path.join(__dirname, "data/swagger.yaml");
  }

  static get providerName() {
    return "sampleService";
  }

  static get serviceName() {
    return "sample-service";
  }

  static get serviceVersion() {
    return "1.0.0";
  }

  //
  // Service hosts are automatically discovered through service registry
  // But if registry is not available, then these provide some default config
  //
  // You don't need to provide this, but it means you may not be able to
  // connect to services if the registry is down.
  //
  static get serviceRegistry() {
    return {
      //
      // default values to always apply if env missing any values.
      // will also override what's in the spec.
      //
      default: {
        ENDPOINT: {
          schemes: ["https", "http"],
          host: "qa.sample-service.qa.walmart.com",
          basePath: "/sample-service"
        },
        ESB_PROXY: {
          schemes: ["http", "https"],
          host: "qa.sample-service.qa.walmart.com",
          basePath: "/service/sample-service"
        }
      },
      // if env is missing or not found, then use these (default still applies)
      missing: {},
      // qa
      qa: {
        ENDPOINT: {
          host: "qa.sample-service.qa.walmart.com"
        },
        ESB_PROXY: {}
      },
      // prod
      prod: {
        ENDPOINT: {
          schemes: ["https"],
          host: "prod1.iam.platform.prod.walmart.com"
        },
        ESB_PROXY: {
          schemes: ["http"],
          host: "ultra-esb.prod-shared1.esb.platform.glb.prod.walmart.com"
        }
      }
    };
  }

  //
  // optional service to service header fields for signing
  //
  static signHeadersList() {
    const wm = ElectrodeSwapi.WM_HEADERS;
    return [ wm.consumerId, wm.svcVersion ].sort();
  }
}

module.exports = SampleClient;
```

And app can use above client:

```js
"use strict";

const SampleClient = require("sample-client");

function handler(req, reply) {
  // Note: in real app code, the client should be
  // created once during startup and reuse
  SampleClient.create(req.app.config).then((client) => {
    client.withMeta(req).foobarOperation({
      paramFoo: {
        foo: "bar"
      }
    }
  });
}
```

However, if your app is base on the Electrode Server platform, then you don't need to manually initialize Swapi clients.  You do that through configuration.  See [details here][initializer-tdlr].

## WalmartLabs extensions

`electrode-swapi` supports the following extension properties in your swagger spec:

### x-wm-sign-headers

`x-wm-sign-headers` - if set to true, and the client provided the `signHeadersList` array of header fields to sign, then those headers will be signed using SOARI consumer private key.

Example: to use this in your swagger spec:

```yaml
  /auth/admin:
    post:
      operationId: authAdmin
      x-wm-sign-headers: true
      security:
        - api_key: []
      responses:
        '200':
          description: test sign headers
```

Here is [an example][iam2-auth-example] of setting the `signHeadersList` array in the IAM2 auth client

### x-wm-optional-params

`x-wm-optional-params` - if set to true, then you can specify optional params in the path with:

-   `{+ParamName}` - the value will not be encoded and replace in the path as is.
-   `{/ParamName}` - the value will be URI encoded and prepended with `/`

## Optional Headers

When you call a operation in the swagger spec, you can pass in two arguments.  The first one is the parameters for operation, and the second one is options.  You can set a `_headers` object in options to add optional headers.

For example:

```js
const parameters = {};
const options = {
  _headers: {
    "optional-header": "value"
  }
};
client.withMeta(request).serviceOperation( parameters, options );
```

## [Static Methods](#static-methods)

#### [`static` create](#static-create)

`static create(data)`

Creates an instance of the `Client` specified in `data`.

data: `{ config, Client, providerName, specFileName, specOverride }`

-   `config` (required) - Electrode app config
-   `Client` (required) - The Electrode Swapi Client
-   `providerName` (optional) - service client provider name.  If not provided, then use `Client.providerName`
-   `specFilename` (optional) - swagger spec filename  If not provided, then use `Client.specFilename`
-   `specOverride` (optional) - explicitly override `host` and `basePath` in spec

**_Returns_** a promise resolving to an instance of the `Client` created.

#### [`static` createSwagger](#static-createswagger)

`static swaggerSwagger(data)`

Create a swagger object with parameters in data.

data: [see `data` for create](#static-create)

Returns a promise resolving to the `swagger` object.

#### [`static` swaggerWithFilename](#static-swaggerwithfilename)

`static swaggerWithFilename(specFile, override)`

Load a swagger spec (JSON or YAML) and create a `Swagger` instance from it.

Example:

```js
const fileName = __dirname + "/data/swagger.yaml";
const override = {host: "localhost"};
ElectrodeSwapi.swaggerWithFileName(fileName, override)
  .then((swagger) => {
  });
```

#### [`static` swaggerWithSpec](#static-swaggerwithspec)

`static swaggerWithSpec(spec, override)`

Create a `Swagger` instance with a spec.

Example:

```js
const override = {host: "localhost"};
ElectrodeSwapi.swaggerWithSpec(spec, override)
  .then((swagger) => {
  });
```

#### [`static` swaggerWithUrl](#static-swaggerwithurl)

`static swaggerWithUrl(url)`

Create a `Swagger` instance with the spec from URL.  No override.

Example:

```js
ElectrodeSwapi.swaggerWithUrl("http://servericehost/swagger.json")
  .then((swagger) => {
  });
```

#### [`static` supportKeepAlive](#static-supportkeepalive)

`static supportKeepAlive(flag)`

Set SWAPI's default `supportKeepAlive` value to `flag`.  This is override by the value specified in config if one exists there.

Example:

```js
ElectrodeSwapi.supportKeepAlive(true)
```

#### [`static` getClient](#static-getclient)

`static getClient(req)`

A getter intended to be used on classes extending ElectrodeSwapi to fetch the client initialized by `electrode-service-initializer`. Accepts a hapi req object and throws if a client is not found.

Example:

```js
const storeFrontClient = StoreFrontClient.getClient(req);
```

## [Methods](#methods)

#### [constructor](#constructor)

`constructor(config, swagger, name)`

-   `config` - Electrode app config
-   `swagger` - swagger object
-   `name` - provider name

Sample Electrode App `config`:

```js
{
  services: {
    verbose: true,
    env: "qa",
    consumerId: "91e1b78e-261b-4676-8317-4cf5bfa24a42",
    privateKey: {
      file: "config/keys/soa-private.pem",
      version: 1,
      algorithm: "RSA",
      encoding: "PKCS#8"
    },
    timeout: {
      response: 4000,
      deadline: 8000
    },
    supportKeepAlive: false,
    providers: {
      "<name>": {
        verbose: true,
        name: "SampleServiceService",
        version: "1.0.0",
        supportKeepAlive: false,
        type: "ENDPOINT",
        wm_headers: true,
        host: "sample-service.qa.walmart.com",
        basePath: "/sample/",
        serviceRegistry: {
          // override static registry data
        },
        port: 80,
        proxy: "http://127.0.0.1:8442",
        timeout: {
          response: 3000,
          deadline: 6000
        },
      }
    }
  }
}
```

Where

-   `services.verbose` - If true, then swapi will log response or error object after calling operation at the "debug" level. Make sure to set your transport to log at "debug" to actually get this data. See the [electrode-logging](https://gecgithub01.walmart.com/electrode/electrode-logging/blob/master/README.md) repo for how to set log levels.

-   `services.supportKeepAlive` - If true or false, then swapi will enable or disable HTTP keep alive agent.

-   `services.timeout` - Timeout to wait for the service call

    -   `response` - Maximum time to wait for the first byte to arrive from the server (in msec). Does not limit how long the entire download can take.
    -   `deadline` - Deadline for entire request (including redirects) to complete (in msec). If the response isn't fully downloaded within that time, request will be aborted.

-   `services.privateKey` - information for the private key you received from SOARI

    -   You will need to convert the private key from the SOA portal to a RSA PEM before it can be used here.
    -   More information about the private key and conversion instructions can be found at <https://gecgithub01.walmart.com/electrode/s2s-auth-signature#misc>

-   `providers.<name>`

    -   The <name> should match the name returned by the _ElectrodeSwapi_ client's static `providerName` property.

-   `providers.<name>.verbose` - Same as `services.verbose` but only apply to `providers.<name>`.  Allows you to turn on/off verbose log for individual provider.

-   `providers.<name>.name`

    -   Name of the service (used to search service registry)

-   `providers.<name>.version`

    -   Version of the service (used to search service registry)

-   `providers.<name>.supportKeepAlive` - If true or false, then swapi will enable or disable HTTP keep alive agent for the specific provider only.

-   `providers.<name>.timeout` - Same as `services.timeout` that overrides it for the particular provider

-   `providers.<name>.type`

    -   Allow you to set the SOA type of the service explicitly (WalmartLabs SOA specific).
        -   `ENDPOINT` or `ESB_PROXY`, the 3rd one `CONTRACT` is not applicable for Swapi.

-   `providers.<name>.wm_headers`

    -   By default, Electrode swapi sends SOARI **_WM_** headers, but if you want to turn off that behavior, then set this to _false_.

-   `providers.<name>.host`

    -   override all other sources of host except the one passed in to `create`

-   `providers.<name>.basePath`

    -   override all other sources of basePath except the one passed in to `create`

-   `providers.<name>.serviceRegistry`

    -   Allow you to set registry data in case service registry is not available.

-   `providers.<name>.proxy`
    -   Allows you to send the request via an HTTP proxy.

#### [validateModel](#validatemodel)

`validateModel(name, obj)`

Manually validate an object against a model in the Swagger spec.

Example:

```js
client.validateModel("AccountInfo", data)
  .then(() => {
    // data pass AccountInfo schema spec
  })
  .catch((err) => {
    // data is invalid
  });
```

#### [addPasswordAuth](#addpasswordauth)

`addPasswordAuth(authName, username, password)`

Add a basic password auth credential to call the APIs.

Example:

```js
client.addPasswordAuth("passwordAuth", "username", "secret");
```

#### [addApiKeyAuth](#addapikeyauth)

`addApiKeyAuth(authName, key, value, type)`

Add an `api_key` auth credential to call the APIs.

Example:

```js
client.addApiKeyAuth("oauthAuth", "Authorization", "secret", "header");
```

#### [invokeWithMeta](#invokewithmeta)

`invokeWithMeta(meta, tag, operationId, params, options)`

Invoke an API by its `tag` name and `operationId`.  If you pass in the `request` object for meta, then the call is automatically instrumented.

Generally it's better to use the [`withMeta`](#withmeta) method to invoke the operations.

Example:

```js
client.invokeWithMeta(request, "Account", "getAccountProfile")
  .then((resp) => {
  });
```

#### [invoke](#invoke)

`invoke(tag, operationId, params, options)`

Example:

```js
client.invoke("Account", "getAccountProfile")
  .then((resp) => {
  });
```

#### [withMeta](#withmeta)

`withMeta(meta)`

Get back an object with the API operations access to `meta`.  Any API operations invoked with this can use `meta`.

Example:

```js
client.withMeta(request)
  .getAccountProfile()
  .then((resp) => {
  });
```

## [Properties](#properties)

#### [name](#name)

Client name (should normally be the name of the service).

#### [swagger](#swagger)

The swagger instance created from parsing the spec.

#### [operations](#operations)

You can access all operations defined by the Swagger spec to the service.

Example:

```js
client.operations.getAccountProfile()
  .then((resp) => {
  })
```

To allow service calls to be automatically instrumented, you should call operations using the [`withMeta`](#withmeta) method.

#### [WM_HEADERS](#wm_headers)

Returns an object with all [WalmartLabs service headers][service-headers]:

```js
{
  consumerId: "WM_CONSUMER.ID",
  consumerIp: "WM_CONSUMER.IP",
  consumerTenantId: "WM_CONSUMER.TENANT_ID",
  consumerInTimestamp: "WM_CONSUMER.INTIMESTAMP",
  consumerSourceId: "WM_CONSUMER.SOURCE_ID",
  svcEnv: "WM_SVC.ENV",
  svcVersion: "WM_SVC.VERSION",
  svcName: "WM_SVC.NAME",
  svcInTimestamp: "WM_SVC.INTIMESTAMP",
  svcOutTimestamp: "WM_SVC.OUTTIMESTAMP",
  corrId: "WM_QOS.CORRELATION_ID",
  ifxClientType: "WM_IFX.CLIENT_TYPE",
  ifxServerName: "WM_IFX.SERVER_NAME",
  ifxTransactionId: "WM_IFX.TRANSACTION_ID",
  secAuthToken: "WM_SEC.AUTH_TOKEN",
  secAuthSig: "WM_SEC.AUTH_SIGNATURE",
  secKeyVersion: "WM_SEC.KEY_VERSION",
  signedHeaders: "SignedHeaders"
}
```

[swagger]: http://swagger.io/

[bluebird]: http://bluebirdjs.com/docs/getting-started.html

[node-es6]: https://nodejs.org/en/docs/es6/#which-features-ship-with-node-js-by-default-no-runtime-flag-required

[iam2-auth-example]: https://gecgithub01.walmart.com/electrode-client/iam2-auth-client/blob/master/lib/iam2-auth-client.js#L21-L25

[service-headers]: https://confluence.walmart.com/pages/viewpage.action?title=SOA+Header+Elements&spaceKey=PGPSOA

[initializer-tdlr]: https://gecgithub01.walmart.com/electrode/electrode-service-initializer#tldr

[electrode-logging]: https://gecgithub01.walmart.com/electrode/electrode-logging

[continuation-local-storage]: https://github.com/othiym23/node-continuation-local-storage

[electrode-log-transaction]: https://gecgithub01.walmart.com/electrode/electrode-log-transaction

[optional-require]: https://github.com/jchip/optional-require
