/* eslint-disable */
/*
 * This file contains the function that's meant to be sent to the browser
 * for rewriting CDN URL strings in Objects to the Torbit rewritten host.
 */

module.exports.rewriteCdnHost = function rewriteCdnHost() {
  function rewriteObjStrings(obj, o, n) {
    var rgx;

    function r(d) {
      for (var k in d) {
        if (d[k]) {
          if (typeof(d[k]) === "object") {
            r(d[k]);
          } else if (typeof(d[k]) === "string") {
            if (d[k].indexOf(o) >= 0) {
              d[k] = d[k].replace(rgx, n);
            }
          }
        }
      }
    }

    if (obj && o && n) {
      rgx = new RegExp(o, 'g');
      r(obj);
    }
  }

  if (!window._wml || !document.head || !document.head.getElementsByTagName) {
    return false;
  }

  var wml = window._wml;

  var x = document.head.getElementsByTagName("script");
  if (x && x.length > 0) {
    for (var i = 0; i < x.length; i++) {
      if (x[i].getAttribute("id") === "cdnHint") {
        wml.cdnHost = x[i].getAttribute("src").split("/")[2];
        break;
      }
    }
  }

  if (wml.defaultCdnHost !== wml.cdnHost) {
    rewriteObjStrings(window.__WML_REDUX_INITIAL_STATE__, wml.defaultCdnHost, wml.cdnHost);
    rewriteObjStrings(window.__REACT_RESOLVER_PAYLOAD__, wml.defaultCdnHost, wml.cdnHost);
    rewriteObjStrings(wml.cdn && wml.cdn.md, wml.defaultCdnHost, wml.cdnHost);
    rewriteObjStrings(wml.config && wml.config.ccm, wml.defaultCdnHost, wml.cdnHost);
  }
  return true;
};
