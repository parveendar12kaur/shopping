# Electrode React Webapp

This is a Hapi plugin that register a default route for your Webapp to return
a bootstrapping React application.  With support for webpack dev server integrations.

## Installing

```
npm install @walmart/electrode-react-webapp2 --save
```

## Usage

### Registering with Hapi

You can use this plugin by registering it with your Hapi server.

```js
const reactWebapp =

server.register({
  register: require("@walmart/electrode-react-webapp2"),
  options: {
    pageTitle: "My Awesome React WebApp",
    paths: {
      "/{args*}": {
        methods: [ "get", "post" ],
        view: "index",
        content: "<h1>Hello React!</h1>"
      }
    }
  }
});
```

For each path, you can set an optional field `methods` to specify the HTTP methods you want that path to support.  If it's not specified, then it's default to `[ "get" ]`.

By default, `get` is always automatically supported.  If you also want a path to support `post`, you should set `methods` to `[ "get", "post" ]`.

It's also important to specify the `methods` attribute with the value `"get,post"` in your `react-router` route that you want to support `post`.

Finally, remember that `post` requests are subjected to CSRF protection.

### Registering with electrode-server

To use this with electrode-server, add to the config you pass to `electrode-server`:

```js
const config = {
  plugins: {
    "@walmart/electrode-react-webapp2": {
      options: {
        pageTitle: "My Awesome React WebApp",
        paths: {
          "/{args*}": {
            methods: [ "get", "post" ],
            view: "index",
            content: "<h1>Hello React!</h1>"
          }
        }
      }
    }
  }
}

require("@walmart/electrode-server")(config);
```

### Multiple Bundles

The `electrode-react-webapp2` plugin support the app configuration with multiple entry points
and allows to select JS and CSS bundles (or "chunks" in the Webpack terms) based on `request`
data. By default, without any configuration, only "main" JS and CSS chunks will be used.

In order to allow specific chunks selection, use `bundleChunkSelector` configuration option:

```js
const config = {
  plugins: {
    "@walmart/electrode-react-webapp2": {
      options: {
        bundleChunkSelector: "./server/chunk-selector.js",
        ...
      }
    }
  }
};
```

Here `chunk-selector.js` is a JS module that should be implemented by the application. This
module should export the function that implements the bundle selection logic:

```js
module.exports = function (request) {
  const userAgent = request.headers["user-agent"].toLowerCase();

  if (userAgent.indexOf("wmtapp") > 0) {
    return {
      js: "mobile",
      css: "mobile"
    };
  }

  return {
    js: "web",
    css: "web"
  };
};
```

This code assumes that the app has 2 entry points named `"mobile"` and `"web"` declared as
entry points in the app's Webpack config.

## Disabling Server-Side Rendering with CCM

At times of high load, it may be desirable to disable Server-Side Rendering, and only render on the client.

The application will check the value of the flag `["electrode-react"].disableServerRenderingConfig`
on each request. If the value is `true`, then Server-Side Rendering will be **disabled** and your application will only
render on the Client. Your redux store will be hydrated with initial data, however.

When the flag is set to `false` or is not set at all, Server-Side Rendering will happen as normal.

Note: This functionality was introduced in version `9.4.1` so please ensure you are on at least that version in order to
use it.

## Using `asyncEnabled` option from CCM

You can specify to always use `asyncEnabled` from CCM by defining your options below.

NOTE: The ccmMap is dependent on co-use of `@walmart/electrode-ccm-client` and defining it correctly with your
application's assigned artifactId (from OneOps and CCM). Example below:
```js
{
  services: {
    providers: {
      "@walmart/electrode-ccm-client": {
        options: {
          artifactId: "foo-app"
        }
      }
    }
  },
  "plugins": {
    "@walmart/electrode-react-webapp2": {
      "options": {
        "ccmMap": {
          "asyncEnabled": "features.enableAsyncBundle"
        }
      }
    }
  }
}
```

## Default options

This plugin has some default options but you can override them by setting your own value.

The current defaults are:

```js
{
  pageTitle: "Untitled Electrode Web Application",
  unbundledJS: {
    enterHead: null,
    preBundle: null
  },
  bodyBundleInHeader: false,
  typekitId: "fqp0lia",
  dnsPrefetch: [],
  metaTags: {
    app: {
      charSet: { charSet: "utf-8" },
      httpEquiv: { httpEquiv: "X-UA-Compatible", content: "IE=edge,chrome=1" },
      viewport: "width=device-width, initial-scale=1.0",
      "apple-mobile-web-app-capable": "yes",
      "google-play-app": "app-id=com.walmart.android",
      "apple-itunes-app": "app-id=338137227"
    },
    seo: {}
  },
  preconnect: [],
  asyncEnabled: false,
  unbundledStyle: null,
  webpackDev: process.env.WEBPACK_DEV === "true",
  renderJS: true,
  serverSideRendering: true,
  ccmPathToCacheTTLValue: ".cache.ttlValue"
  devServer: {
    protocol: "http",
    host: "127.0.0.1",
    port: "2992"
  },
  paths: {}
}
```

## Options

What you can do with the options:

   * `pageTitle` (String) The value to be shown in the browser's title bar
   * `pageTitleSuffix` (String) Suffix to be added to every page title. For example, " - Walmart.com"
   * `unbundledJS` (Object) Specify JavaScript files to be loaded at an available extension point in the index template
     - `enterHead` (Array) Array of script objects (`{ src: "path to file" }`) to be inserted as `<script>` tags in the document `head` before anything else. To load scripts asynchronously use `{ src: "...", async: true }` or `{ src: "...", defer: true }`
     - `preBundle` (Array) Array of script objects (`{ src: "path to file" }`) to be inserted as `<script>` tags in the document `body` before the application's bundled JavaScript
   * `bodyBundleInHeader` (Boolean) Whether to put the web bundle in the document `head`.
   * `typekitId` (String) Typekit id of the font library to load.
   * `dnsPrefetch` (Array) Array of urls which needs to be DNS-Prefetched by clients. Each App could configure its own set of domains for prefetching.
   * `metaTags` (Object) Override default meta tags or add new ones.
       - `app` (Object) Generic meta tags. See default options above for usage examples. You can remove a default meta tag by setting the value to `null` or any other falsey value.
       - `seo` (Object) SEO related meta tags handled by [@walmart/electrode-seo-metadata](https://gecgithub01.walmart.com/electrode/electrode-seo-metadata)
       - `seoOptions` (Object) Options affecting how electrode-seo-metadata processes seo metadata. See electrode-seo-metadata docs.
   * `preconnect` (Array) Array of urls which leverage the browser preconnect capability. Informing in advance which sockets would need ahead of initiating the actual requests via this hint.
   * `asyncEnabled` (Boolean) JS bundle loaded asynchronously, by default it is disabled. One may also specify `asyncEnabled` from CCM via the use of `ccmMap` option, see below.
   * `ccmMap` (Object) Currently only supports `asyncEnabled`. Setting the `ccmMap` key with a corresponding object definition will allow for a webapp consumer to specify the CCM key path to access for toggling `asyncEnabled` from CCM.
   * `unbundledStyle` (Array) Array of paths to stylesheets not part of the application itself (such as a CDN hosted stylesheet for a library or similar)
   * `webpackDev` (Boolean) whether to use webpack-dev-server's URLs for retrieving CSS and JS bundles.
   * `serverSideRendering` (Boolean) Toggle server-side rendering.
   * `devServer` (Object) Options for webpack's DevServer
       - `host` (String) The host that webpack-dev-server runs on
       - `port` (String) The port that webpack-dev-server runs on
   * `paths` (Object) An object of key/value pairs specifying paths within your application with their view and (optionally) initial content for server-side render
     - _path_ (Object)
       - `view` (String) Name of the view to be used for this path **required**
       - `content` Content to be rendered by the server when server-side rendering is used _optional_ [see details](#content-details)
   * `excludeTorbitContentCheck` (Boolean) A flag allowing to exclude the content from Torbit checksum calculation.
   * `ccmPathToCacheTTLValue` (String) CCM path to the TTL value to add Cache Headers **Cache-Control**, **Last-Modified**, **Expires**. The TTL value is expressed in *milliseconds*. A **Zero** value will be interpreted as *NO* cache headers. any value greater than Zero will add the Cache headers.
   *Default:* `false`
   * `ccmPathToCookieListDisablements` (String) Path to the comma-separated list of cookies to look for in order to bypass Akamai cache headers. Works in conjunction with ***ccmPathToCacheTTLValue*** if cookie is not found or string value is malformed.
    - Usage in CCM: ***CID, hasCID*** will look for these values associated with a logged in use and prevent passing Akamai cache headers
   * `ccmPathToManualShelfTTLWhitelist` (String) Path to the comma-separated list of manual shelf pages and their associated ttl cache values in ms.
    - Usage in CCM: ***_be_shelf_id=12345: 300000, _be_shelf_id=56789: 900000*** will set the ttlCache time to 300 seconds for the shelf page "12345" and 900 seconds (15 minutes) for shelf page "56789". This will override ***ccmPathToCacheTTLValue*** and could be overridden by ***ccmPathToCookieListDisablements*** if those whitelisted cookies are also found on those shelf pages.

### Content details

The content you specify for your path can either be a string or a promise returning function.

If it's a string, it's treated as a straight React template to be rendered.

If it's a function, the function should return a promise that resolves an object:

```js
function myContent() {
  return Promise.resolve({
    status: 200,
    html: "<h1>Hello React!</h1>",
    prefetch: ""
  });
}
```

## Support/Contact

Dave Stevens <dstevens@walmartlabs.com> Slack: @dstevens

Joel Chen <xchen@walmartlabs.com> Slack: @joelchen

Also see Slack Channels `#react` or `#electrode`

