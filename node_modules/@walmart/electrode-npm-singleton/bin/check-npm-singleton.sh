#!/usr/bin/env bash


function check_npm_singleton() {
  fname=/tmp/npm-singletons.$$.txt
  find node_modules -name package.json | xargs -n 20 grep -l "\".*electrode-npm-singleton\":" > $fname

  x=`cat $fname | sed "s/node_modules\//~/g" | rev | cut -f1 -d~ | cut -f2- -d\/ | rev | sort | uniq -c | grep -v " *1 " | rev | cut -f1 -d\  | rev`

  for s in $x; do
    echo "ERROR: Module $s needs to have only one install but found multiple as listed below"
    echo ""
    grep "$s\/" $fname
    echo ""
  done

  rm -f $fname

  if [ -n "$x" ]; then
    return 1
  else
    return 0
  fi
}

if ! check_npm_singleton; then
  echo bummer!
fi
