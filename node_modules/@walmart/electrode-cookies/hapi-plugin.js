"use strict";

var each = require("lodash/each");
const { universalHapiPlugin } = require("@walmart/electrode-hapi-compat");

function electrodeCookiesRegister17(server, options) {
  server.ext("onPreResponse", (request, h) => {
    if (request.app.replyStates) {
      each(request.app.replyStates, (state, name) => {
        h.state(name, state.value, state.options);
      });
    }

    return h.continue;
  });
}

function electrodeCookiesRegister16(server, options, next) {
  server.ext("onPreResponse", (request, reply) => {
    // istanbul ignore else
    if (request.app.replyStates) {
      each(request.app.replyStates, (state, name) => {
        reply.state(name, state.value, state.options);
      });
    }

    return reply.continue();
  });

  next();
}

const pkg = require("./package.json");

const registers = {
  hapi16: electrodeCookiesRegister16,
  hapi17: electrodeCookiesRegister17
};
module.exports = universalHapiPlugin(registers, pkg);
