"use strict";
/* eslint-disable no-magic-numbers */

const optionalRequire = require("optional-require")(require);
const clsProvider = optionalRequire("@walmart/electrode-cls-provider");
const fyi = require("@walmart/electrode-fyi");
const tryCatch = require("@walmart/try-catch");
const stack = require("./stack");

const hasCls = Boolean(clsProvider && clsProvider.getRequest);

fyi.info(`ui-config: clsProvider.getRequest${hasCls ? "" : " not"} available`);

const fyiInfo = fyi.limitInfo("ui-config", 50);

/* eslint-disable max-len */

function getRequest(opts, from) {
  let req;

  if (opts) {
    req = opts.request || opts;
  }

  // user didn't pass in opts or opts.request
  if (!req) {
    // do we have CLS provider?
    if (hasCls) {
      //
      // Get request from CLS provider to lookup dynamic CCM configs base
      // on each request
      //
      req = tryCatch(clsProvider.getRequest);
      if (!req && !fyiInfo.end) {
        fyiInfo(
          `ui-config.${from} no opts.request and failed to get request from CLS - will lookup from server only\n`,
          stack.get()
        );
      }
    } else if (!fyiInfo.end) {
      fyiInfo(
        `ui-config.${from} no opts.request and no CLS to get request from - will lookup from server only`,
        stack.get()
      );
    }
  }

  return req || {};
}

module.exports = getRequest;
