"use strict";

const support = require("electrode-archetype-react-app/support");
const electrodeServer = require("@walmart/electrode-wml-server");
const electrodeConfig = require("@walmart/electrode-config");
const verifyDep = require("./verify");
const fyi = require("@walmart/electrode-fyi");
const ccmPreload = require("@walmart/electrode-ccm-preload");
const Promise = require("bluebird");

module.exports = function(supportConfig, appConfig) {
  supportConfig = supportConfig || {};
  return Promise.try(verifyDep)
    .then(() => support.load(supportConfig))
    .then(() => {
      const config = appConfig || electrodeConfig.config;
      if (supportConfig.ccmPreload) {
        return ccmPreload({ config })
          .then(r => r.config)
          .catch(err => {
            fyi.warn("ccmPreload failed", err);
            return config;
          });
      }
      return config;
    })
    .then(config => electrodeServer(config))
    .catch(err => {
      fyi.error("Starting App Server failed", err.stack);
      throw err;
    });
};
