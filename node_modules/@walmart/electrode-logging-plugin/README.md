# electrode-logging-plugin

A Hapi plugin for logging [server events](http://hapijs.com/api#server-events) using
[`electrode-logging`].

[Enabled by default](https://gecgithub01.walmart.com/electrode/electrode-wml-server/blob/master/lib/config/default.js)
in `electrode-wml-server`.

## Support

Release notes are in [`CHANGELOG.md`](/CHANGELOG.md). To get help or report a
problem, [file an issue](https://gecgithub01.walmart.com/electrode/electrode-logging-plugin/issues/new).

Maintainers: [@jwils98](https://gecgithub01.walmart.com/jwils98) [@awest5](https://gecgithub01.walmart.com/awest5)

## What it does

1. Handles `server.log` and `request.log` calls using an [`electrode-logging`] logger
2. Logs requests and responses
3. Wraps each request-response in a top-level transaction\*
4. Reads and sets correlation header and `request.app.correlationId`
5. Logs `request-internal` events at `trace` level, `request-error` events at `error`
   (see [hapi server events](http://hapijs.com/api#server-events))

\* _Can be disabled altogether or per request; see [below](#transactions)_.

More information about transactions and logging can be found in [`electrode-logging`].

Source code: [`lib/logging.js`](https://gecgithub01.walmart.com/electrode/electrode-logging-plugin/blob/master/lib/logging.js)

## Request.id

Additionally, if the request occurs in a One-Ops environement, the request.id is modified so it indicates exactly where the request occurred.

    `${profile}.${env}.${cloud}.${instance}.` +
    `${appInstance}.${ts}${counter}`;

where `ts` is the timestamp.

For example, suppose we have

    ONEOPS_ENVPROFILE=STG
    ONEOPS_ENVIRONMENT=stage-green
    ONEOPS_CLOUD_COMPUTE_SERVICE=dal3
    ONEOPS_COMPUTE_CI_ID=215749430

Then our `request.id` will be

    'STG.stage-green.dal3.215749430.<appInstance><timestamp>'

and followed by the app instance in [PM2](http://pm2.keymetrics.io/docs/usage/environment/#specific-environment-variables) along with the timestamp and a counter in the event of two requests at the same time on the same app instance.

### Configuration

The plugin creates a `Logger` instance using `server.app.config.logging`, same as
`electrode-logging`. See [logging configuration docs](https://gecgithub01.walmart.com/electrode/electrode-logging#configuration).

#### verboseRequest flag
If `verboseRequest` is set to `true`, this plugin will log in verbose mode for the `Request received` by setting the flag in your configuration, e.g.

    server.app.config = {
      logging: {
        verboseRequest: true,
        transports: [{ type: "stdout" }]
      }
    };

This change will not affect subsequent req.log calls.

#### verboseResponse flag
If `verboseResponse` is set to `true`, this plugin will log in verbose mode for the `Response` by setting the flag in your configuration, e.g.

    server.app.config = {
      logging: {
        verboseReseponse: true,
        transports: [{ type: "stdout" }]
      }
    };

You can have both `verboseRequest` and `verboseResponse` enabled at the same time.

#### Transactions

If config's `logging.disableTransactions` is true, requests will not be wrapped in a transaction.

Transactions can also be disabled on a single request by setting `request.app.disableTransactions`
to true. For example, [`electrode-log-consumer`](https://gecgithub01.walmart.com/electrode/electrode-log-consumer)
disables transactions for requests to the api logging endpoint.

[`electrode-logging`]: https://gecgithub01.walmart.com/electrode/electrode-logging
