"use strict";

const path = require("path");
const _ = require("lodash");

const appPkg = require(path.resolve("package.json"));

let warned = false;

let logger = {};

exports.setServer = _server => (logger = _server);

exports.sendEvent = (eventName, eventData) => {
  if (process.send) {
    process.send({
      type: "process:apm",
      data: _.merge(
        {
          event: eventName,
          appName: process.env.name,
          appVersion: appPkg.version,
          appInstance: process.env.NODE_APP_INSTANCE
        },
        eventData
      )
    });
  } else if (!warned && logger.log) {
    logger.log(["warn", "metrics"], "Unable to send metrics; process has no send method");
    warned = true;
  }
};
