# electrode-metrics

Electrode metrics library. Sends metrics data to [`electrode-apm`], which
aggregates it and reports to kafka.

## Support

Release notes: [`CHANGELOG.md`](/CHANGELOG.md). Slack channel: `#electrode-apm`

## Usage

**For full compatibility with electrode-apm, be sure to use v1.6.0 or above.**

Run `npm ls @walmart/electrode-metrics` to see what version(s) you have installed.

### Integration with electrode environment

`electrode-metrics` is used to instrument the following libraries:

| Library                | Starting at | Reports          |
| ---------------------- | ----------- | ---------------- |
| `electrode-wml-server` | `2.2.0`     | HTTP responses\* |
| `electrode-swapi`      | `1.12.1`    | service calls    |
| `electrode-fetch`      | `6.1.0`     | fetch calls      |

\* If you don't wish to upgrade to the above version of `electrode-wml-server`,
you can still have all your app server's responses reported by enabling the
plugin yourself:

1.  Add a dependency on `@walmart/electrode-metrics`
2.  Add to your config, under `plugins`, `"@walmart/electrode-metrics": { enable: true }`

## Reporting Event Loop Delay

This module provides a Hapi plugin that when registered, will measure and report NodeJS event loop delay to [`electrode-apm`].

If you are using [`electrode-wml-server`] then the plugin is automatically registered and enabled.

The event loop delay is measured by an `100ms` interval.  Any time beyond that in firing the interval is considered an event loop delay.

To configure the event loop delay measuring behavior, in your app config, you can pass these options:

```js
{
  plugins: {
    "@walmart/electrode-metrics": {
      options: {
        threshold: 100,
        reportingInterval: false
      }
    }
  }
}
```

-   `threshold` - `[number]` specify the delay threshold in msec.  **_DEFAULT_**: `0`
-   `reportingInterval` - `[false|number]` specify the interval in msec to report event delay data to APM.  Set it to `false` to disable event loop delay measuring and reporting.  **_DEFAULT_**: `1000`

### threshold

By default, any delay larger than `0` is reported to a histogram.  This allows you to see a fairly continuous data of your process' event loop firing delay.

Optionally, you can set a threshold such that the delay is only reported if it's higher than the threshold.

For example, if you set a threshold of `100` and the delay were always below that, then you would get a histogram with only `0` values.

## More info

-   [`electrode-apm`]
-   [Platform Metrics Client Specification](https://confluence.walmart.com/display/STRSTEL/Electrode+Platform+Metrics+Client+Specification)
-   [`measured`](https://gecgithub01.walmart.com/electrode-core/node-measured)

[`electrode-apm`]: https://gecgithub01.walmart.com/electrode-core/electrode-apm

[`electrode-wml-server`]: https://gecgithub01.walmart.com/electrode/electrode-wml-server

[spec]: https://confluence.walmart.com/display/STRSTEL/Electrode+Platform+Metrics+Client+Specification#ElectrodePlatformMetricsClientSpecification-MetricNameandPayloadFormat
