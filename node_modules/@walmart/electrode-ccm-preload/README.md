# Electrode CCM Preload

Preload settings from CCM into your app config

This module provides a restricted CCM config loading before the actual app server starts, in order to allow updating app config with values from CCM.

This module is hardcoded to look at a fixed CCM configName `electrode-app-config` for retrieving properties to update your app config.

# Table Of Contents

* [Install](#install)
* [Usage](#usage)
  * [Sample use with Electrode WML Server](#sample-use-with-electrode-wml-server)
  * [CCM Connectivity](#ccm-connectivity)
* [Setup App Config In CCM](#setup-app-config-in-ccm)
  * [Specifying Config](#specifying-config)
    * [CCM Key Starts with `$` For JSON String](#ccm-key-starts-with--for-json-string)
    * [CCM Key As JSON Path](#ccm-key-as-json-path)
    * [CCM Key Starts with `-` For Deleting](#ccm-key-starts-with---for-deleting)
* [API](#api)
  * [`ccmPreload(options)`](#ccmpreloadoptions)

# Install

```bash
npm i --save @walmart/electrode-ccm-preload
```

# Usage

## Sample use with Electrode WML Server

If your app is already setup with Electrode app config, then you can use this module like this:

```js
const ccmPreload = require("@walmart/electrode-ccm-preload");
const electrodeConfig = require("@walmart/electrode-config");
const electrodeServer = require("@walmart/electrode-wml-server");

const config = electrodeConfig.config;
ccmPreload({ config }).then(() => electrodeServer(config));
```

## CCM Connectivity

Obviously, this module needs to be able to connect to the CCM services.

Due to WML SOARI discovery achitecture, it relies on its user to provide the discovery parameters.

There are two ways to do that:

1. Directly pass an instance of the [electrode-ccm-client] that you've created.

2. Pass your app config with the Electrode specific `services` properties to it. It will use that to discover the corresponding CCM service and instantiate an [electrode-ccm-client].

   Typically, your app config should contain a [`services` section similar to this sample](./test/fixtures/config.js).

   This module will copy the `services` section with only the `@walmart/electrode-ccm-client` provider, and then discover and initialize the CCM client.

# Setup App Config In CCM

## Specifying Config

Under the CCM configName `electrode-app-config`, you can set CCM properties in the following ways, applied in the order specified:

1. keys start with `-` (delete fields in your app config directly)
2. keys not start with `$` (set value using comma separated JSON path)
3. keys start with `$` (process value as JSON string)

The keys in each group are processed in alphabetical order, with their values merge into a single object, which is then finally merge into your app config.

### CCM Key Starts with `$` For JSON String

By using CCM key names that start with `$` and set the value to a JSON string:

* CCM Key: `$json`
* CCM Value: `{"services":{"providers":{"@walmart/electrode-geo-client":{"enabled":false}}}}`

You can also enclose the value with one of the JS string quotes:

`'{"services":{"providers":{"@walmart/electrode-geo-client":{"enabled":false}}}}'`

### CCM Key As JSON Path

By specifying a key that's a string of comma separated JSON path.

The value is processed with the following rules:

* If it's enclosed by `'`, `"`, or backtick, then it's a string with the quotes removed. All intermediate quotes remain as is.
* If it's one of these: `false`, `true` then it's converted to boolean accordingly.
* If it contains only `[+\-\.0-9]` and `parseFloat` on it doesn't return `NaN`, then it's treated as a number.
* Finally it's treated as a string.

For example:

* CCM Key: `services,providers,@walmart/electrode-geo-client,enabled`
* CCM Value: `false`

will update or set the following value in your app config to `false`:

```js
{
  services: {
    providers: {
      "@walmart/electrode-geo-client": {
        enabled: false
      }
    }
  }
}
```

> Note that CCM key has a size limit of 255 characters so if your JSON path string is longer than that, you'd have to use the [JSON string approach](#ccm-key-start-with--for-json-string) to set your config.

### CCM Key Starts with `-` For Deleting

By specifying a key that starts with `-` to delete a field from your app config.

You specify what to delete from your app config by setting the value to a string of comma separated JSON path.

For example:

* CCM Key: `-delete-store-front-client`
* CCM Value: `services,providers,@walmart/store-front-client`

Will delete `config.services.providers["@walmart/store-front-client"]`

# API

## `ccmPreload(options)`

Where `options` supports the following properties:

* `config` - (require) Your app config. It will be updated and mutated with CCM properties.
* `ccmClient` - (optional) Pass an instance of CCM client.
* `scopeTemplate` - (optional) CCM scope template. **Default**: `/{environment}/{cloud}/{node}/`
* `scopeContext` - (optional) Object that resolves values for the template.
* `serviceName` - (optional) CCM serviceName. **Default**: the `name` field from your app's `package.json`.
* `configName` - (optional) CCM configName to load CCM properties. **Default**: `electrode-app-config`

Returns a `Promise` that resolves to object with these properties:

* `config` - your updated app config (your copy mutated)
* `ccmPartial` - The app config that's generated from CCM `set` and `json` properties
* `updateProps` - The verbatim properties from CCM

`updateProps` has the following properties:

* `set` - contains the CCM key values for [CCM Key As JSON Path](#ccm-key-as-json-path)
* `json` - contains the CCM key values for [CCM Key Starts with `$` For JSON String](#ccm-key-starts-with--for-json-string)
* `del` - contains the CCM key values for [CCM Key Starts with `-` For Deleting](#ccm-key-starts-with---for-deleting)
* `count` - total CCM key values combined

[electrode-ccm-initializer]: https://gecgithub01.walmart.com/electrode/electrode-ccm-initializer
[electrode-ccm-client]: https://gecgithub01.walmart.com/electrode-client/electrode-ccm-client
