"use strict";

const chai = require("chai");
const expect = chai.expect;
const es = require("@walmart/electrode-server");
const sa = require("superagent");

describe("app-config-plugin", function () {
  function testWithServer(repairCookie) {
    let server;
    return es({
      plugins: {
        "@walmart/electrode-appconfig": {
          module: process.cwd(),
          options: {
            repairCookie
          }
        }
      }
    })
      .then((s) => {
        server = s;
        server.route({
          method: "GET",
          path: "/test",
          handler: (request, reply) => {
            expect(request.app.config).to.be.ok;
            if (repairCookie) {
              expect(request.headers.cookie).to.equal(`a=1;b=123;c=4;e=;f=" 12345"`);
            }
            reply({});
          }
        });
        const req = sa.get("http://localhost:3000/test");
        if (repairCookie) {
          req.set("cookie", `a=1;; b=123;;c=4;e=;f=" 12345"`);
        }
        return req.then(() => "");
      })
      .finally(() => server && server.stop());
  }

  it("should add config to req.app", () => testWithServer());

  it("should repair malformed cookies from some proxies/routers", () => testWithServer(true));

});

